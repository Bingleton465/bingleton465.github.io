<!-- Ultimate Game Stash file -->
<!-- For the regularly updating doc go to https://docs.google.com/document/d/1_FmH3BlSBQI7FGgAQL59-ZPe8eCxs35wel6JUyVaG8Q/ -->
<!-- Made by Genizy -->

<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Softbody Car Crash 3D</title>
  <link rel="icon" href="images/icons/car-icon.png" type="image/png">
  <meta name="description" content="3D Softbody Car Crash Simulator using Three.js & Ammo.js">
  <link rel="stylesheet" href="css/style.css?v=1">
  <style>
    body { margin:0; overflow:hidden; background:linear-gradient(black,darkred); }
    #gameContainer { width:100vw; height:100vh; }
    #loader {
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:linear-gradient(black,darkred);
    }
    .spinner {
      border:1.1em solid rgba(255,255,255,0.2);
      border-left-color:#fff; border-radius:50%;
      width:5em; height:5em; animation:spin 1.1s linear infinite;
      margin:20px;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .progress {
      position:relative; width:436px; height:24px; display:none;
    }
    .progress .back { width:100%; }
    .progress .front {
      position:absolute; top:0; left:0;
      transform-origin:left center; width:100%;
    }
  </style>
  <!-- Three.js and Ammo.js from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ammojs3@0.0.11/ammo.wasm.js"></script>
</head>
<body>
  <div id="gameContainer"></div>
  <div id="loader">
    <img src="images/loading-logo.png?v=1" alt="Loading" style="max-width:200px;">
    <div class="spinner"></div>
    <div class="progress">
      <img class="back" src="images/progress-back.png?v=1">
      <img class="front" src="images/progress-front.png?v=1">
    </div>
  </div>

  <script>
  // Wait for Ammo to initialize
  Ammo().then(AmmoLib => {
    Ammo = AmmoLib;

    // Basic Three.js setup
    const scene    = new THREE.Scene();
    const camera   = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0,4,15);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    document.getElementById('gameContainer').appendChild(renderer.domElement);

    // Lights
    const light = new THREE.DirectionalLight(0xffffff,1);
    light.position.set(10,10,5);
    scene.add(light);

    // Physics world with softbody
    const cfg    = new Ammo.btSoftBodyRigidBodyCollisionConfiguration();
    const dsp    = new Ammo.btCollisionDispatcher(cfg);
    const bp     = new Ammo.btDbvtBroadphase();
    const sol    = new Ammo.btSequentialImpulseConstraintSolver();
    const sbSol  = new Ammo.btDefaultSoftBodySolver();
    const world  = new Ammo.btSoftRigidDynamicsWorld(dsp,bp,sol,cfg,sbSol);
    world.setGravity(new Ammo.btVector3(0,-9.8,0));
    world.getWorldInfo().set_m_gravity(new Ammo.btVector3(0,-9.8,0));

    // Ground
    const groundMat = new THREE.MeshStandardMaterial({ color:0x555555 });
    const groundGeo = new THREE.PlaneGeometry(50,50);
    const groundMesh = new THREE.Mesh(groundGeo, groundMat);
    groundMesh.rotation.x = -Math.PI/2;
    scene.add(groundMesh);
    const groundBody = new Ammo.btRigidBody(
      new Ammo.btRigidBodyConstructionInfo(0,
        new Ammo.btDefaultMotionState(
          new Ammo.btTransform().setIdentity()
        ),
        new Ammo.btBoxShape(new Ammo.btVector3(25,0.1,25))
      )
    );
    world.addRigidBody(groundBody);

    // Create softbody box chassis
    const boxSize = 2;
    const boxGeo = new THREE.BoxGeometry(boxSize, boxSize, boxSize, 4,4,4);
    const softMat = new THREE.MeshStandardMaterial({ color:0xff0000, wireframe:true });
    const softMesh = new THREE.Mesh(boxGeo, softMat);
    scene.add(softMesh);

    // Extract vertices & indices
    const posAttr = boxGeo.attributes.position;
    const verts = [];
    for (let i=0; i<posAttr.count; i++) {
      verts.push(posAttr.getX(i), posAttr.getY(i), posAttr.getZ(i));
    }
    const idx = boxGeo.index.array;

    // Ammo softbody creation
    const sbHelper = new Ammo.btSoftBodyHelpers();
    const softBody = sbHelper.CreateFromTriMesh(
      world.getWorldInfo(),
      verts, idx, idx.length/3, true
    );
    softBody.get_m_materials().at(0).set_m_kLST(0.8);
    softBody.get_m_materials().at(0).set_m_kAST(0.8);
    softBody.setTotalMass(5, false);
    Ammo.castObject(softBody, Ammo.btCollisionObject)
         .getCollisionShape()
         .setMargin(0.05);
    world.addSoftBody(softBody, 1, -1);

    // Sync and animate
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      world.stepSimulation(dt, 10);

      // Update soft mesh vertices
      const nodes = softBody.get_m_nodes();
      for (let i = 0; i < nodes.size(); i++) {
        const node = nodes.at(i);
        const v = node.get_m_x();
        boxGeo.attributes.position.setXYZ(i, v.x(), v.y(), v.z());
      }
      boxGeo.attributes.position.needsUpdate = true;
      softMesh.position.set(0,3,0);

      renderer.render(scene, camera);
    }
    animate();

    // Hide loader
    const loader = document.getElementById('loader');
    loader.querySelector('.progress').style.display = 'block';
    loader.querySelector('.spinner').style.display = 'none';
    loader.style.display = 'none';
  });
  </script>
</body>
</html>
